{% extends 'base.html' %}
{% load custom_tags %}
{% load widget_tweaks %}
<style>
    /* üñº –î–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–¥–∞—á—ñ */
    .card-img-top {
        width: 100%;
        max-height: 350px;
        object-fit: contain !important;
        background-color: #f8f9fa;
        border-radius: 10px;
    }

    /* üí¨ –î–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å —É –∫–æ–º–µ–Ω—Ç–∞—Ä—è—Ö */
    .card-body img.img-fluid {
        max-width: 180px;
        max-height: 180px;
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
        margin: 10px 0;
        border-radius: 10px;
        background-color: #f8f9fa;
    }

    /* üé• –î–ª—è –≤—ñ–¥–µ–æ ‚Äî —â–æ–± —Ç–µ–∂ –≤–ø–∏—Å—É–≤–∞–ª–∏—Å—å —É —Ä–∞–º–∫—É */
    .card-body video.img-fluid {
        max-width: 250px;
        max-height: 200px;
        object-fit: contain;
        border-radius: 10px;
        display: block;
        margin: 10px 0;
    }

    /* üß© –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É */
    .card-body img,
    .card-body video {
        margin-left: auto;
        margin-right: auto;
    }
</style>
{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="card shadow-lg border-0 mb-4">
        {% if task.file %}
            {% with url=task.file.url|lower %}
                {% if url|endswith:'.jpg' or url|endswith:'.jpeg' or url|endswith:'.png' or url|endswith:'.gif' %}
                    <img src="{{ task.file.url }}" alt="{{ task.title }}" class="card-img-top" style="max-height: 400px; object-fit: cover;">
                {% elif url|endswith:'.mp4' or url|endswith:'.webm' or url|endswith:'.mov' %}
                    <video controls class="w-100" style="max-height: 400px; object-fit: cover;">
                        <source src="{{ task.file.url }}" type="video/mp4">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–µ–æ.
                    </video>
                {% else %}
                    <a href="{{ task.file.url }}" target="_blank" class="d-block p-3">üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</a>
                {% endif %}
            {% endwith %}
        {% endif %}

        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="fw-bold mb-0">{{ task.title }}</h2>

                <form method="post" action="{% url 'task-complete' task.id %}">
                    {% csrf_token %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               id="task-{{ task.id }}"
                               name="is_completed"
                               onchange="this.form.submit()"
                               {% if task.is_completed %}checked{% endif %}>
                        <label class="form-check-label fw-semibold" for="task-{{ task.id }}">
                            ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                        </label>
                    </div>
                </form>
            </div>

            <p class="lead text-muted">{{ task.description }}</p>

            {% if task.file %}
                <div class="mb-3">
                    <h6 class="fw-bold">–ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏–π —Ñ–∞–π–ª:</h6>
                    <a href="{{ task.file.url }}" target="_blank" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª ({{ task.file.name|slice:"-4:" }})
                    </a>
                    <p class="text-muted small mt-1">–†–æ–∑–º—ñ—Ä: {{ task.file.size|filesizeformat }}</p>
                </div>
            {% endif %}

            <div class="mb-3">
                <span class="badge
                    {% if task.status == 'done' %} bg-success
                    {% elif task.status == 'in_progress' %} bg-warning text-dark
                    {% else %} bg-secondary
                    {% endif %}">
                    {{ task.get_status_display }}
                </span>

                <span class="badge
                    {% if task.priority == 'high' %} bg-danger
                    {% elif task.priority == 'medium' %} bg-primary
                    {% else %} bg-info text-dark
                    {% endif %}">
                    üî• {{ task.get_priority_display }}
                </span>
            </div>

            <p class="mb-1"><b>üìÖ –î–µ–¥–ª–∞–π–Ω:</b> {{ task.due_date|date:"d M Y" }}</p>
            <p class="mb-1"><b>üïí –°—Ç–≤–æ—Ä–µ–Ω–æ:</b> {{ task.created_at|date:"d M Y H:i" }}</p>
            <p class="mb-3"><b>üë§ –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</b> {{ task.user.username }}</p>

            <div class="d-flex gap-2 mb-3">
                <a href="{% url 'task-update' task.pk %}" class="btn btn-outline-secondary">‚úè –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                <a href="{% url 'task-delete' task.pk %}" class="btn btn-outline-danger">üóë –í–∏–¥–∞–ª–∏—Ç–∏</a>
                <a href="{% url 'task-list' %}" class="btn btn-outline-dark">‚¨Ö –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
            </div>
        </div>
    </div>

    <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
    <div class="mt-5">
        <h4 class="fw-bold mb-3">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h4>

        {% for comment in comments %}
            <div class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">
                            üë§ {{ comment.author.username }}
                            <small class="text-muted">‚Äî {{ comment.created_at|date:"d M Y H:i" }}</small>
                        </h6>
                        <div>
                            {% if comment.author == user %}
                                <a href="{% url 'comment-edit' comment.id %}" class="btn btn-sm btn-outline-warning me-1">‚úè</a>
                                <a href="{% url 'comment-delete' comment.id %}" class="btn btn-sm btn-outline-danger">üóë</a>
                            {% endif %}
                        </div>
                    </div>

                    <p>{{ comment.content }}</p>

                    {% if comment.media %}
                        {% with url=comment.media.url|lower %}
                            {% if url|endswith:'.png' or url|endswith:'.jpg' or url|endswith:'.jpeg' or url|endswith:'.gif' %}
                                <img src="{{ comment.media.url }}" class="img-fluid rounded shadow-sm mb-2">
                            {% elif url|endswith:'.mp4' or url|endswith:'.webm' or url|endswith:'.ogg' %}
                                <video src="{{ comment.media.url }}" controls class="img-fluid rounded shadow-sm mb-2"></video>
                            {% endif %}
                        {% endwith %}
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>{{ comment.author.username }}</strong>
                        <small class="text-muted">{{ comment.created_at|date:"d M Y H:i" }}</small>
                    </div>

                    <div class="mt-3">
                        <a href="{% url 'comment-like' comment.id %}" class="btn btn-sm btn-outline-primary">
                            ‚ù§Ô∏è {{ comment.likes.count }}
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º! üöÄ</p>
        {% endfor %}
    </div>

    <!-- –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä -->
    <div class="card shadow-sm border-0 mt-4 mb-5">
        <div class="card-body">
            <h5 class="fw-bold mb-3">üìù –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</h5>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.content|add_class:"form-control" }}
                </div>

                <div class="mb-3">
                    <label for="id_media" class="form-label fw-semibold">üìé –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
                    {{ form.media|add_class:"form-control" }}
                </div>

                <button type="submit" class="btn btn-success">üíæ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}